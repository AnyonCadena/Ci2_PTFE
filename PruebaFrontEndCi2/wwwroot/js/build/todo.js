$(function(){$("#filtroTodas").attr("checked",!0),peticionObtenerTareas(listarTareas)});var idBorrar,idActualizar,api_url="https://drsgps.co/protectedapi",autorizacion_url="https://drsgps.co/identity",local_url="http://localhost:5003",configuracion={authority:autorizacion_url,client_id:"js",redirect_uri:local_url+"/callback.html",response_type:"id_token token",scope:"openid profile api1",post_logout_redirect_uri:local_url+"/index.html"},gestionUsuario=new Oidc.UserManager(configuracion);function listarTareas(){var a="";return""!=$("#textoDescripcion").val()&&(a+="descripcion="+$("#textoDescripcion").val()),$("#filtroTodas").is(":checked")?a:$("#filtroFinalizadas").is(":checked")?(a+=""!=$("#textoDescripcion").val()?"&":"",a+="finalizada=true"):$("#filtroPendientes").is(":checked")?(a+=""!=$("#textoDescripcion").val()?"&":"",a+="finalizada=false"):a}function inicioSesion(){gestionUsuario.signinRedirect()}function cerrarSesion(){gestionUsuario.signoutRedirect()}function peticionObtenerTareas(r){gestionUsuario.getUser().then(function(a){var e=api_url+"/tareas/consultar?"+r,i=new XMLHttpRequest;i.open("GET",e),i.onload=function(){var a=JSON.parse(i.responseText),e="";a.forEach(function(a){e+='<div class="card" style="margin-bottom:10px"><div class="modal-body">',e+='<div><div class="form-group-sm">',e+='<label for="descripcion'+a.id+'" class="font-weight-bold">Descripción: </label>',e+='<label id="descripcion'+a.id+'">'+a.descripcion+"</label>",e+='</div><div class="form-group-sm">',e+='<label for="fechaVencimiento'+a.id+'"class="font-weight-bold">Fecha de vencimiento: </label>',e+='<label id="fechaVencimiento'+a.id+'">'+a.fechaVencimiento+"</label>",e+='</div><div class="form-group-sm">',e+='<label for="Estado'+a.id+'" class="font-weight-bold">Finalizada: </label>',e+='<label id="Estado'+a.id+'">'+(1==a.finalizada?"Si":"No")+"</label>",e+="</div></div></div>",e+='<div class="modal-footer">',e+='<button value="'+a.id+'" onclick="abrirModalActualizar(\''+a.id+'\')" name="actualizarTarea" type="button" class="btn btn-primary">Actualizar</button>',e+='<button value="'+a.id+'" onclick="abrirModalBorrar(\''+a.id+'\')" name="borrarTarea" type="button" class="btn btn-danger"> Borrar</button>',e+="</div></div>"}),document.getElementById("divTareas").innerHTML=e,0==a.length&&(document.getElementById("divTareas").innerHTML='<span class="bg-light">No hay tareas registradas</span>')},i.setRequestHeader("Authorization","Bearer "+a.access_token),i.send(null)})}function crearTarea(){peticionCrearTarea({descripcion:$("#descripcion").val(),fechaVencimiento:$("#fechaVencimiento").val()})}function borrarTarea(){null!=idBorrar&&peticionBorrarTarea(idBorrar)}function actualizarTarea(){null!=idActualizar&&peticionActualizarTarea({id:idActualizar,descripcion:$("#descripcionActualizar").val(),fechaVencimiento:$("#fechaVencimientoActualizar").val(),finalizada:$("#filtroFinalizadasActualizar").is(":checked")})}function abrirModalBorrar(a){$("#modalBorrarTarea").modal("show"),idBorrar=a}function abrirModalActualizar(a){idActualizar=a,$("#descripcionActualizar").text($("#descripcion"+a).text()),$("#fechaVencimientoActualizar").val($("#fechaVencimiento"+a).text().substring(0,10)),"No"==$("#Estado"+a).text()?$("#filtroPendientesActualizar").attr("checked",!0):$("#filtroFinalizadasActualizar").attr("checked",!0),$("#modalActualizarTarea").modal("show")}function mostrarAlerta(a,e,i){$("#cuadroAlerta").hide(),$("#cuadroAlerta").show(),$("#cuadroAlerta").addClass(a),$("#tituloAlerta").append(e),$("#mensajeAlerta").append(i)}function peticionCrearTarea(r){gestionUsuario.getUser().then(function(a){var e=api_url+"/tareas/crear",i=new XMLHttpRequest;i.open("POST",e),i.setRequestHeader("Content-Type","application/json"),i.onload=function(){$("#modalCrearTarea").modal("hide"),mostrarAlerta("alert-success","!Exito¡","La tarea ha sido creada exitosamente"),peticionObtenerTareas(listarTareas())},i.setRequestHeader("Authorization","Bearer "+a.access_token),i.send(JSON.stringify(r))})}function peticionActualizarTarea(r){gestionUsuario.getUser().then(function(a){var e=api_url+"/tareas/actualizar",i=new XMLHttpRequest;i.open("POST",e),i.setRequestHeader("Content-Type","application/json"),i.onload=function(){$("#modalActualizarTarea").modal("hide"),mostrarAlerta("alert-success","!Exito¡","La tarea ha sido actualizada exitosamente"),idActualizar=null,peticionObtenerTareas(listarTareas())},i.setRequestHeader("Authorization","Bearer "+a.access_token),i.send(JSON.stringify(r))})}function peticionBorrarTarea(r){gestionUsuario.getUser().then(function(a){var e=api_url+"/tareas/borrar",i=new XMLHttpRequest;i.open("POST",e),i.setRequestHeader("Content-Type","application/json"),i.onload=function(){$("#modalBorrarTarea").modal("hide"),mostrarAlerta("alert-success","!Exito¡","La tarea ha sido borrada exitosamente"),idBorrar=null,peticionObtenerTareas(listarTareas())},i.setRequestHeader("Authorization","Bearer "+a.access_token),i.send(JSON.stringify({id:r}))})}gestionUsuario.getUser().then(function(a){a?($("#contenidoPagina").show(),peticionObtenerTareas(listarTareas())):$("#inicioDeSesion").show()}),$("#btnNuevaTarea").click(function(){$("#descripcion").val(""),$("#fechaVencimiento").val("")}),$("#inicioSesion").click(function(){inicioSesion()}),$("#cerrarSesion").click(function(){cerrarSesion()}),$("#crearTarea").click(function(){crearTarea()}),$("#borrarTarea").click(function(){borrarTarea()}),$("#actualizarTarea").click(function(){actualizarTarea()}),$("#filtroTodas").change(function(){peticionObtenerTareas(listarTareas())}),$("#filtroFinalizadas").click(function(){peticionObtenerTareas(listarTareas())}),$("#filtroPendientes").click(function(){peticionObtenerTareas(listarTareas())}),$("#buscarTareas").click(function(){peticionObtenerTareas(listarTareas())});